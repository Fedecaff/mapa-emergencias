<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó∫Ô∏è Mapa de Emergencias - Catamarca</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="css/estilos.css">
    
    <!-- Configuraci√≥n de la aplicaci√≥n -->
    <script>
        window.CONFIG = {
            API_URL: 'http://localhost:8080/api'
        };
    </script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-map-marked-alt"></i>
                <h1>Mapa de Emergencias</h1>
            </div>
            
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="userName"></span>
                <button id="emergencyBtn" class="btn-emergency">
                    <i class="fas fa-fire"></i> EMERGENCIA
                </button>
                <button id="logoutBtn" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
            
            <div class="auth-buttons" id="authButtons">
                <button id="loginBtn" class="btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n
                </button>
            </div>
            
            <!-- Bot√≥n para colapsar sidebar en m√≥vil -->
            <button id="toggleSidebarBtn" class="btn-toggle-sidebar" style="display: none;">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <!-- Contenedor principal -->
    <div class="main-container">
        <!-- Panel lateral -->
        <aside class="sidebar" id="sidebar">
            <!-- Panel de b√∫squeda -->
            <div class="search-panel">
                <h3><i class="fas fa-search"></i> B√∫squeda</h3>
                <div class="search-input">
                    <input type="text" id="searchInput" placeholder="Buscar puntos...">
                    <button id="searchBtn">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>

            <!-- Panel de filtros -->
            <div class="filters-panel">
                <h3><i class="fas fa-filter"></i> Filtros</h3>
                <div class="filter-group">
                    <label>Categor√≠as:</label>
                    <div id="categoryFilters" class="category-filters">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>
                

            </div>

            <!-- Panel de disponibilidad (solo para operadores) -->
            <div class="availability-panel" id="availabilityPanel" style="display: none;">
                <h3><i class="fas fa-user-check"></i> Mi Disponibilidad</h3>
                <div class="availability-toggle">
                    <label class="availability-checkbox">
                        <input type="checkbox" id="availabilityCheckbox">
                        <span class="checkmark"></span>
                        <span class="availability-text">Estoy disponible para emergencias</span>
                    </label>
                </div>
                <div class="availability-status" id="availabilityStatus">
                    <i class="fas fa-circle"></i>
                    <span>Estado: No disponible</span>
                </div>
            </div>

            <!-- Panel de ubicaci√≥n -->
            <div class="location-panel">
                <h3><i class="fas fa-location-arrow"></i> Mi Ubicaci√≥n</h3>
                <button id="centerLocationBtn" class="btn-location">
                    <i class="fas fa-crosshairs"></i> Centrar en mi ubicaci√≥n
                </button>
                <div id="locationInfo" class="location-info">
                    <!-- Informaci√≥n de ubicaci√≥n -->
                </div>
            </div>

            <!-- Panel de perfil de usuario -->
            <div class="profile-panel" id="profilePanel" style="display: none;">
                <h3><i class="fas fa-user"></i> Mi Perfil</h3>
                
                <!-- Botones de modo -->
                <div class="profile-mode-buttons">
                    <button id="viewInfoBtn" class="btn-mode btn-mode-active">
                        <i class="fas fa-eye"></i> Ver Info
                    </button>
                    <button id="editInfoBtn" class="btn-mode">
                        <i class="fas fa-edit"></i> Editar Info
                    </button>
                </div>
                
                <div class="profile-info">
                    <div class="profile-avatar">
                        <img id="profileAvatar" src="" alt="Foto de perfil" style="display: none;">
                        <div id="profileInitials" class="profile-initials"></div>
                        <button id="changePhotoBtn" class="btn-change-photo">
                            <i class="fas fa-camera"></i> Cambiar foto
                        </button>
                    </div>
                    
                    <div class="profile-fields">
                        <div class="form-group">
                            <label for="profileName">Nombre:</label>
                            <input type="text" id="profileName" placeholder="Tu nombre completo">
                        </div>
                        
                        <div class="form-group">
                            <label for="profileInstitution">Instituci√≥n:</label>
                            <select id="profileInstitution">
                                <option value="">Seleccionar instituci√≥n</option>
                                <option value="Bomberos Voluntarios de Valla Viejo">Bomberos Voluntarios de Valla Viejo</option>
                                <option value="Bomberos Voluntarios de San Fernando">Bomberos Voluntarios de San Fernando</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="profileRole">Rol en la instituci√≥n:</label>
                            <select id="profileRole">
                                <option value="">Seleccionar rol</option>
                                <option value="Bombero">Bombero</option>
                                <option value="Oficial">Oficial</option>
                                <option value="Comandante">Comandante</option>
                                <option value="Conductor">Conductor</option>
                                <option value="Rescatista">Rescatista</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="profilePhone">Tel√©fono:</label>
                            <input type="tel" id="profilePhone" placeholder="Tu n√∫mero de tel√©fono">
                        </div>
                    </div>
                    
                    <div class="profile-actions">
                        <button id="saveProfileBtn" class="btn-save-profile">
                            <i class="fas fa-save"></i> Guardar cambios
                        </button>
                    </div>
                    

                </div>
            </div>

            <!-- Panel de administraci√≥n (solo para admins) -->
            <div class="admin-panel" id="adminPanel" style="display: none;">
                <h3><i class="fas fa-cog"></i> Administraci√≥n</h3>
                <button id="addPointBtn" class="btn-admin">
                    <i class="fas fa-plus"></i> Agregar Punto
                </button>
                <button id="createUserBtn" class="btn-admin">
                    <i class="fas fa-user-plus"></i> Crear Usuario
                </button>
                <button id="viewHistoryBtn" class="btn-admin">
                    <i class="fas fa-history"></i> Ver Historial
                </button>
            </div>

            <!-- Panel de operadores (solo para admins) -->
            <div class="operators-panel" id="operatorsPanel" style="display: none;">
                <h3><i class="fas fa-users"></i> Operadores Disponibles</h3>
                
                <!-- Checkbox para mostrar/ocultar operadores en el mapa -->
                <div class="operators-map-toggle">
                    <label class="operators-checkbox">
                        <input type="checkbox" id="showOperatorsMapCheckbox">
                        <span class="checkmark"></span>
                        <span class="operators-text">Mostrar operadores en el mapa</span>
                    </label>
                </div>
                
                <div class="operators-list" id="operatorsList">
                    <!-- Lista de operadores se cargar√° din√°micamente -->
                </div>
                <div class="operators-status">
                    <i class="fas fa-circle"></i>
                    <span id="operatorsCount">0 operadores disponibles</span>
                </div>
            </div>
        </aside>

        <!-- Mapa principal -->
        <main class="map-container">
            <div id="map"></div>
            
            <!-- Controles del mapa -->
            <div class="map-controls">
                <button id="fullscreenBtn" class="map-control-btn" title="Pantalla completa">
                    <i class="fas fa-expand"></i>
                </button>
                <button id="resetViewBtn" class="map-control-btn" title="Vista inicial">
                    <i class="fas fa-home"></i>
                </button>
            </div>
        </main>
    </div>

    <!-- Modal de login -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n</h2>
                <button class="close-btn" id="closeLoginModal">&times;</button>
            </div>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Contrase√±a:</label>
                    <input type="password" id="password" name="password" required>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">Iniciar Sesi√≥n</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de agregar punto -->
    <div id="addPointModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2><i class="fas fa-plus"></i> Agregar Nuevo Punto</h2>
                <button class="close-btn" id="closeAddPointModal">&times;</button>
            </div>
            <form id="addPointForm" class="point-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="pointName">Nombre:</label>
                        <input type="text" id="pointName" name="nombre" required>
                    </div>
                    <div class="form-group">
                        <label for="pointCategory">Categor√≠a:</label>
                        <select id="pointCategory" name="categoria_id" required>
                            <!-- Se llena din√°micamente -->
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="pointDescription">Descripci√≥n:</label>
                    <textarea id="pointDescription" name="descripcion" rows="3"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="pointLat">Latitud:</label>
                        <input type="number" id="pointLat" name="latitud" step="any" required>
                    </div>
                    <div class="form-group">
                        <label for="pointLng">Longitud:</label>
                        <input type="number" id="pointLng" name="longitud" step="any" required>
                    </div>
                </div>
                
                <div id="customFields" class="custom-fields">
                    <!-- Campos personalizados por categor√≠a -->
                </div>
                
                <div class="form-actions">
                    <button type="button" id="cancelAddPoint" class="btn-secondary">Cancelar</button>
                    <button type="submit" class="btn-primary">Agregar Punto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de editar punto -->
    <div id="editPointModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> Editar Punto</h2>
                <button class="close-btn" id="closeEditPointModal">&times;</button>
            </div>
            <form id="editPointForm" class="point-form">
                <input type="hidden" id="editPointId" name="id">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editPointName">Nombre:</label>
                        <input type="text" id="editPointName" name="nombre" required>
                    </div>
                    <div class="form-group">
                        <label for="editPointCategory">Categor√≠a:</label>
                        <select id="editPointCategory" name="categoria_id" required>
                            <!-- Se llena din√°micamente -->
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editPointDescription">Descripci√≥n:</label>
                    <textarea id="editPointDescription" name="descripcion" rows="3"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editPointLat">Latitud:</label>
                        <input type="number" id="editPointLat" name="latitud" step="any" required>
                    </div>
                    <div class="form-group">
                        <label for="editPointLng">Longitud:</label>
                        <input type="number" id="editPointLng" name="longitud" step="any" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editPointStatus">Estado:</label>
                    <select id="editPointStatus" name="estado" required>
                        <option value="activo">Activo</option>
                        <option value="inactivo">Inactivo</option>
                        <option value="mantenimiento">En Mantenimiento</option>
                    </select>
                </div>
                
                <div id="editCustomFields" class="custom-fields">
                    <!-- Campos personalizados por categor√≠a -->
                </div>
                
                <div class="form-actions">
                    <button type="button" id="cancelEditPoint" class="btn-secondary">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de detalles del punto -->
    <div id="pointDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="pointDetailsTitle"><i class="fas fa-info-circle"></i> Detalles del Punto</h2>
                <button class="close-btn" id="closePointDetailsModal">&times;</button>
            </div>
            <div id="pointDetailsContent" class="point-details">
                <!-- Contenido din√°mico -->
            </div>
            <div class="modal-actions" id="pointDetailsActions">
                <!-- Botones de acci√≥n -->
            </div>
        </div>
    </div>

    <!-- Modal de Historial -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-history"></i> Historial de Cambios</h2>
                <button class="close-btn" id="closeHistoryModal">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Filtros -->
                <div class="history-filters">
                    <div class="form-group">
                        <label for="historyTableFilter">Filtrar por tabla:</label>
                        <select id="historyTableFilter">
                            <option value="">Todas las tablas</option>
                            <option value="puntos">Puntos</option>
                            <option value="categorias">Categor√≠as</option>
                            <option value="usuarios">Usuarios</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="historyActionFilter">Filtrar por acci√≥n:</label>
                        <select id="historyActionFilter">
                            <option value="">Todas las acciones</option>
                            <option value="crear">Creaci√≥n</option>
                            <option value="actualizar">Actualizaci√≥n</option>
                            <option value="eliminar">Eliminaci√≥n</option>
                        </select>
                    </div>
                </div>
                
                <!-- Lista del historial -->
                <div id="historyList" class="history-list">
                    <p>Cargando historial...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Crear Usuario (Solo Admin) -->
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> Crear Nuevo Usuario</h2>
                <span class="close" id="closeCreateUserModal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="form-group">
                        <label for="newUserName">Nombre completo:</label>
                        <input type="text" id="newUserName" name="nombre" required>
                    </div>
                    <div class="form-group">
                        <label for="newUserEmail">Email:</label>
                        <input type="email" id="newUserEmail" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="newUserPhone">Tel√©fono:</label>
                        <div class="phone-input-group">
                            <span class="phone-prefix">+54 9</span>
                            <input type="tel" id="newUserPhone" name="telefono" required 
                                   placeholder="3834123456" 
                                   pattern="^\d{10}$"
                                   maxlength="10">
                        </div>
                        <small>Formato: 3834123456 (10 d√≠gitos sin espacios)</small>
                    </div>
                    <div class="form-group">
                        <label for="newUserPassword">Contrase√±a:</label>
                        <input type="password" id="newUserPassword" name="password" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label for="newUserRole">Rol:</label>
                        <select id="newUserRole" name="rol" required>
                            <option value="">Seleccionar rol</option>
                            <option value="operador">Operador</option>
                            <option value="administrador">Administrador</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Crear Usuario
                        </button>
                        <button type="button" class="btn btn-secondary" id="cancelCreateUser">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Fotos -->
    <div id="modalFotos" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-camera"></i> Fotos del Punto</h2>
                <button class="close-btn btn-cerrar">&times;</button>
            </div>
            <div class="modal-body">
                <div class="fotos-header">
                    <h3 class="fotos-title">Galer√≠a de Fotos</h3>
                    <button class="btn-subir-foto" id="btnSubirFoto">
                        <i class="fas fa-upload"></i> Subir Foto
                    </button>
                </div>
                <div id="contenedorFotos" class="contenedor-fotos">
                    <!-- Se llena din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Subir Foto -->
    <div id="modalSubirFoto" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-upload"></i> Subir Nueva Foto</h2>
                <button class="close-btn btn-cerrar">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formSubirFoto" class="upload-form">
                    <div class="file-input-group">
                        <input type="file" id="inputFoto" class="file-input" accept="image/*" required>
                        <label for="inputFoto" id="labelFoto" class="file-label">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Seleccionar foto</span>
                            <small>JPG, PNG, HEIC - M√°ximo 5MB</small>
                        </label>
                    </div>
                    
                    <div class="preview-container">
                        <img id="previewFoto" alt="Vista previa">
                    </div>
                    
                    <div class="form-group">
                        <label for="inputDescripcion">Descripci√≥n (opcional):</label>
                        <textarea id="inputDescripcion" name="descripcion" rows="3" 
                                  placeholder="Describe la foto..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-upload"></i> Subir Foto
                        </button>
                        <button type="button" class="btn btn-secondary btn-cerrar">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Foto Completa -->
    <div id="modalFotoCompleta" class="modal">
        <div class="modal-content">
            <button class="close-btn btn-cerrar">&times;</button>
            <img id="imgFotoCompleta" alt="Foto completa">
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n de Emergencia -->
    <div id="modalConfirmacionEmergencia" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-exclamation-triangle"></i> Confirmar Alerta de Emergencia</h2>
                <button class="close-btn btn-cerrar">&times;</button>
            </div>
            <div class="modal-body">
                <div class="emergency-warning">
                    <i class="fas fa-fire" style="color: #e74c3c; font-size: 48px;"></i>
                    <h3>¬øEst√°s seguro de que quieres crear una alerta de emergencia?</h3>
                    <p>Esta acci√≥n enviar√° una notificaci√≥n a todos los bomberos disponibles.</p>
                </div>
                <div class="form-actions">
                    <button id="confirmarEmergenciaBtn" class="btn btn-danger">
                        <i class="fas fa-fire"></i> S√ç, CREAR ALERTA
                    </button>
                    <button class="btn btn-secondary btn-cerrar">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Formulario de Emergencia -->
    <div id="modalFormularioEmergencia" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-fire"></i> Alerta de Emergencia</h2>
                <button class="close-btn btn-cerrar">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formEmergencia" class="emergency-form">
                    <div class="form-group">
                        <label for="emergencyType">Tipo de Emergencia:</label>
                        <select id="emergencyType" name="tipo" required>
                            <option value="">Seleccionar tipo</option>
                            <option value="incendio_estructural">Incendio Estructural</option>
                            <option value="incendio_forestal">Incendio Forestal</option>
                            <option value="accidente_vehicular">Accidente Vehicular</option>
                            <option value="rescate">Rescate</option>
                            <option value="fuga_gas">Fuga de Gas</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="emergencyPriority">Prioridad:</label>
                        <select id="emergencyPriority" name="prioridad" required>
                            <option value="alta">Alta - Inmediata</option>
                            <option value="media" selected>Media - En 15 min</option>
                            <option value="baja">Baja - En 30 min</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="emergencyTitle">T√≠tulo de la Emergencia:</label>
                        <input type="text" id="emergencyTitle" name="titulo" required 
                               placeholder="Ej: Incendio en casa de la esquina">
                    </div>

                    <div class="form-group">
                        <label for="emergencyDescription">Descripci√≥n:</label>
                        <textarea id="emergencyDescription" name="descripcion" rows="3" 
                                  placeholder="Describe la situaci√≥n de emergencia..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Ubicaci√≥n Seleccionada:</label>
                        <div class="location-display">
                            <p><i class="fas fa-map-marker-alt"></i> Ubicaci√≥n marcada en el mapa</p>
                            <div class="coordinates-display">
                                <span>Latitud: <span id="emergencyLat">-</span></span>
                                <span>Longitud: <span id="emergencyLng">-</span></span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="emergencyAddress">Direcci√≥n (opcional):</label>
                        <input type="text" id="emergencyAddress" name="direccion" 
                               placeholder="Direcci√≥n espec√≠fica">
                    </div>

                    <div class="form-group">
                        <label for="emergencyPeople">Personas Afectadas:</label>
                        <input type="number" id="emergencyPeople" name="personas_afectadas" 
                               min="0" value="0">
                    </div>

                    <div class="form-group">
                        <label for="emergencyRisks">Riesgos Espec√≠ficos:</label>
                        <textarea id="emergencyRisks" name="riesgos_especificos" rows="2" 
                                  placeholder="Ej: Gas, qu√≠micos, personas atrapadas..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="emergencyConcurrence">Concurrencia Solicitada:</label>
                        <select id="emergencyConcurrence" name="concurrencia_solicitada">
                            <option value="1">1 Bombero</option>
                            <option value="2">2 Bomberos</option>
                            <option value="3">3 Bomberos</option>
                            <option value="4">4 Bomberos</option>
                            <option value="5">5 Bomberos</option>
                            <option value="todos">Todos los disponibles</option>
                        </select>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-fire"></i> ENVIAR ALERTA
                        </button>
                        <button type="button" class="btn btn-secondary btn-cerrar">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Cargando...</p>
        </div>
    </div>

    <!-- Notificaciones -->
    <div id="notifications" class="notifications"></div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="js/config.js"></script>
    <script src="js/utilidades.js"></script>
    <script src="js/autenticacion.js"></script>
    <script src="js/geolocalizacion.js"></script>
    <script src="js/mapa.js"></script>
    <script src="js/administracion.js"></script>
    <script src="js/usuarios.js"></script>
    <script src="js/fotos.js"></script>
    <script src="js/alertas.js"></script>
    <script src="js/app.js"></script>

</body>
</html>
